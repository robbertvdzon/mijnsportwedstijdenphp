<?
namespace dbcalls;

/* Include Files *********************/
include_once ("database.php");
/*************************************/


/**************************************************
 */
function logSQL($sql,$description, $type) {
    global $conn;
    $username = getSessionUserName();
    logSQL2($sql,$description, $type, $username);
}

/**************************************************
 */
function logSQL2($sql,$description, $type, $username) {
    global $conn;
    $sql = mysql_real_escape_string($sql);
    $username = mysql_real_escape_string($username);
    $description = mysql_real_escape_string($description);
    $q = "INSERT INTO log (`username` , `date`, `time`, `statement`, `type`, `description`) VALUES ('".$username."',CURDATE(), NOW() ,'".$sql."',".$type.",'".$description."')";
    $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}



/**************************************************
 */
function teamnameTaken($teamname) {
	global $conn;
	if (!get_magic_quotes_gpc()) {
		$username = addslashes($teamname);
	}
	$q = "select teamname from team where teamname = '$teamname'";
	$result = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	return (mysql_numrows($result) > 0);
}

/**************************************************
 */
function getSessionUserName() {
	global $conn;
	if (!isset($_SESSION['username']))
		return "";
	$username = $_SESSION['username'];
	return $username;
}
 
/**************************************************
 */
function getUserID($username) {
	global $conn;
	$q = "select id from users where username = '".mysql_real_escape_string($username)."'";
	$res = mysql_query($q, $conn);
	$num = mysql_numrows($res);
	if ($num == 0)
		return -1;
	$userID = mysql_result($res, 0);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	return $userID;
}


/**************************************************
 */
function getUserData($userID) {
    global $conn;
    $item = new \stdClass();
    
    if ($userID==-99){
        // this is the anonymous user
        $item -> id = -99;
        $item -> email = "";
        $item -> name = "Anoniem";
        $item -> username = "anoniem";
        $item -> phonenumber = "";
        return $item;
    }
    
    
    $q = "select * from users where id = '$userID'";
    $result = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    if ($num == 0) {
        return null;
    }
    $item -> id = mysql_result($result, 0, "id");
    $item -> email = mysql_result($result, 0, "email");
    $item -> name = mysql_result($result, 0, "name");
    $item -> username = mysql_result($result, 0, "username");
    $item -> phonenumber = mysql_result($result, 0, "phonenumber");
    
    return $item;
}


/**************************************************
 */
function saveUser($userID,$name,$email,$phonenumber) {
    global $conn;
    $email = mysql_real_escape_string($email);
    $name = mysql_real_escape_string($name);
    $phonenumber = mysql_real_escape_string($phonenumber);
        
    $q = "UPDATE users SET email='$email' , name='$name', phonenumber='$phonenumber'".
    "  WHERE id = '$userID';";
    logSQL($q,"saveUser", 0);
    
    $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }    
}


/**************************************************
 */
function getUsername($userID) {
	global $conn;
	$q = "select * from users where id = '$userID'";
	$result = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$num = mysql_numrows($result);
	if ($num == 0) {
		throw new \Exception("gebruiker niet gevonden");
		return null;
	}
	$name = mysql_result($result, 0, "username");
	if ($name == null) {
		$name = mysql_result($result, 0, "id");
	}
	return $name;
}


/**************************************************
 */
function getName($userID) {
    global $conn;
    $q = "select * from users where id = '$userID'";
    $result = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    if ($num == 0) {
        throw new \Exception("gebruiker niet gevonden");
        return null;
    }
    $name = mysql_result($result, 0, "name");
    return $name;
}

/**************************************************
 */
function addNewManagedOrganisation($org, $userID) {
    global $conn;
    $q = "INSERT INTO managedcompetitionorganisation (`userID` , `description`) VALUES ($userID,'".mysql_real_escape_string($org)."')";
    logSQL($q,"add managedcompetitionorganisation", 0);

    $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $id = mysql_insert_id();
    return $id;
}

/**************************************************
 */
function addNewManagedSeason($season, $orgID) {
    global $conn;
    $q = "INSERT INTO managedcompetitionseason (`managedCompetitionOrganisationID` , `description`) VALUES ($orgID,'".mysql_real_escape_string($season)."')";
    logSQL($q,"add managedcompetitionseason", 0);

    $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $id = mysql_insert_id();
    return $id;
}

/**************************************************
 */
function addNewManagedCompetition($compName, $seasonID) {
    global $conn;
    $q = "INSERT INTO managedcompetition (`managedCompetitionSeasonID` , `description`) VALUES ($seasonID,'".mysql_real_escape_string($compName)."')";
    logSQL($q,"add managedcompetition", 0);

    $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $id = mysql_insert_id();
    return $id;
}



/**************************************************
 */
function addNewTeamMember($teamID, $userID, $nickname) {
	global $conn;
	$q = "INSERT INTO teammember (`teamID` , `userID`, `nickname`, `admin`) VALUES ($teamID,$userID,'".mysql_real_escape_string($nickname)."','1')";
    logSQL($q,"add user", 0);

	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$id = mysql_insert_id();
	return $id;
}

/**************************************************
 */
function addNewTeam($teamname, $userID) {
	global $conn;

	// check if user exists and get hist name
	$name = getUsername($userID);
	if ($name == null)
		return;

	// insert team
	$q = "INSERT INTO team (`teamname`) VALUES ('".mysql_real_escape_string($teamname)."')";
    logSQL($q,"add team", 0);
	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$teamID = mysql_insert_id();

	// insert teammember
	addNewTeamMember($teamID, $userID, $name);
    
    // insert new season
    addSeasons($teamID, date("Y"));
    

	return $teamID;
}


/**************************************************
 */
function loadTeam($teamID) {
    global $conn;
    $item = new \stdClass();
    
    $q = "select * from team where id = '$teamID'";
    $result = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    if ($num == 0) {
        return $item;
    }

    $item -> id = mysql_result($result, 0, "id");
    $item -> teamname = mysql_result($result, 0, "teamname");
    $item -> vereniging = mysql_result($result, 0, "vereniging");
    $item -> sport = mysql_result($result, 0, "sport");
    $item -> voorkeursNrAanwezig = mysql_result($result, 0, "voorkeursNrAanwezig");
    $item -> reminderDays = mysql_result($result, 0, "reminderDays");
    $item -> tekortMailTo = mysql_result($result, 0, "tekortMailTo");
    $item -> waarschuwingMailTo = mysql_result($result, 0, "waarschuwingMailTo");
    $item -> waarschuwingMailDagen = mysql_result($result, 0, "waarschuwingMailDagen");    
    $item -> listname1 = mysql_result($result, 0, "listname1");
    $item -> listname2 = mysql_result($result, 0, "listname2");
    $item -> listname3 = mysql_result($result, 0, "listname3");
    $item -> listname4 = mysql_result($result, 0, "listname4");
    $item -> listname5 = mysql_result($result, 0, "listname5");
    $item -> listname6 = mysql_result($result, 0, "listname6");
    $item -> listname7 = mysql_result($result, 0, "listname7");
    $item -> listname8 = mysql_result($result, 0, "listname8");
    $item -> listname9 = mysql_result($result, 0, "listname9");
    $item -> listname10 = mysql_result($result, 0, "listname10");
    $item -> listtype1 = mysql_result($result, 0, "listtype1");
    $item -> listtype2 = mysql_result($result, 0, "listtype2");
    $item -> listtype3 = mysql_result($result, 0, "listtype3");
    $item -> listtype4 = mysql_result($result, 0, "listtype4");
    $item -> listtype5 = mysql_result($result, 0, "listtype5");
    $item -> listtype6 = mysql_result($result, 0, "listtype6");
    $item -> listtype7 = mysql_result($result, 0, "listtype7");
    $item -> listtype8 = mysql_result($result, 0, "listtype8");
    $item -> listtype9 = mysql_result($result, 0, "listtype9");
    $item -> listtype10 = mysql_result($result, 0, "listtype10");
    if ($item -> vereniging==null) $item -> vereniging = ""; 
    if ($item -> sport==null) $item -> sport = ""; 
    return $item;
}




/**************************************************
 */
function saveTeam($teamID, $teamname, $vereniging, $sport, $voorkeursNrAanwezig, $reminderDays, $tekortMailTo, $waarschuwingMailTo, $waarschuwingMailDagen) {
    global $conn;

    $teamname = mysql_real_escape_string($teamname); 
    $vereniging = mysql_real_escape_string($vereniging); 
    $sport = mysql_real_escape_string($sport); 
    $voorkeursNrAanwezig = mysql_real_escape_string($voorkeursNrAanwezig); 
    $reminderDays = mysql_real_escape_string($reminderDays); 
    $tekortMailTo = mysql_real_escape_string($tekortMailTo); 
    $waarschuwingMailTo = mysql_real_escape_string($waarschuwingMailTo); 
    $waarschuwingMailDagen = mysql_real_escape_string($waarschuwingMailDagen);
        
    $q = "UPDATE team SET ".
    "teamname='$teamname'".
    ", vereniging='$vereniging'".
    ", sport='$sport'".
    ", voorkeursNrAanwezig='$voorkeursNrAanwezig'".
    ", reminderDays='".$reminderDays."'".
    ", tekortMailTo='".$tekortMailTo."'".
    ", waarschuwingMailTo='".$waarschuwingMailTo."'".
    ", waarschuwingMailDagen='".$waarschuwingMailDagen."'".    
    "  WHERE id = '$teamID';";
    logSQL($q,"saveTeam", 0);
    
    $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}


/**************************************************
 */
function loadTeams($userID) {
    global $conn;
    $array = array();
    $query = "SELECT team.teamname, team.id FROM team,teammember where teammember.userID=$userID and team.id=teammember.teamID and (teammember.deleted=0 || teammember.deleted is NULL)";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $teamname = mysql_result($result, $i, "teamname");
        $teamid = mysql_result($result, $i, "team.id");
        $item = new \stdClass();
        $item -> id = $teamid;
        $item -> teamname = $teamname;
        $array[] = $item;
        $i++;
    }
    return $array;
}

/**************************************************
 */
function loadTeams2($userID,$anonymousTeam,$anonymousTeamID) {
	global $conn;
	$array = array();
	$query = "SELECT team.teamname, team.id FROM team,teammember where teammember.userID=$userID and team.id=teammember.teamID and (teammember.deleted=0 || teammember.deleted is NULL)";
	$result = mysql_query($query, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$num = mysql_numrows($result);
	$i = 0;
	$anonymousTeamIDFound = false;
	while ($i < $num) {
		$teamname = mysql_result($result, $i, "teamname");
		$teamid = mysql_result($result, $i, "team.id");
		$item = new \stdClass();
		$item -> id = $teamid;
		$item -> teamname = $teamname;
		$array[] = $item;
		$i++;
        if ($teamid==$anonymousTeamID) $anonymousTeamIDFound = true;
	}
	
	
	// If needed, add the anonymousTeam to the list!!!
	if ($anonymousTeam && !$anonymousTeamIDFound){
        $query = "SELECT team.teamname, team.id  FROM team where team.id=$anonymousTeamID";
        $result = mysql_query($query, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }
        $num = mysql_numrows($result);
        $i = 0;
        while ($i < $num) {
            $teamname = mysql_result($result, $i, "teamname");
            $teamid = mysql_result($result, $i, "team.id");
            $item = new \stdClass();
            $item -> id = $teamid;
            $item -> teamname = $teamname;
            $array[] = $item;
            $i++;
        }
    }
	
	return $array;
}

/**************************************************
 */
function loadGames($seasonID) {
    global $conn;
    $array = array();
    $query = "SELECT * FROM games where seasonID='" . $seasonID . "' order by games.datetime";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $gamedate = mysql_result($result, $i, "datetime");
        $gameid = mysql_result($result, $i, "id");
        $opponent = mysql_result($result, $i, "opponent");
        
        $item = new \stdClass();
        $item -> id = $gameid;
        $item -> gamedate = $gamedate;
        $item -> opponent = $opponent;
        $item -> homegame = mysql_result($result, $i, "homegame");
//        $item -> membersPresentUnknown = mysql_result($result, $i, "membersPresentUnknown");
        $item -> membersPresentYes = mysql_result($result, $i, "membersPresentYes");
        $item -> membersPresentNo = mysql_result($result, $i, "membersPresentNo");
        $item -> score = mysql_result($result, $i, "score");
        $item -> points = mysql_result($result, $i, "points");
        $item -> gameType = mysql_result($result, $i, "gameType");
        $item -> gameStatus = mysql_result($result, $i, "gameStatus");
        if ($item -> points==null) $item -> points = 0;
        if ($item -> score==null) $item -> score = "";
        $array[] = $item;
        $i++;
    }
    return $array;
}

/**************************************************
 */
function deleteGame($gameID) {
    global $conn;
    $array = array();
    $query = "DELETE FROM games where id='" . $gameID."'";
    logSQL($query,"deleteGame", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}

/**************************************************
 */
function findFirstUpcomingGame($teamID) {
    global $conn;

    $item = new \stdClass();
    $item -> id = -1;
    $item -> gameID = -1;
    $item -> seasonID = -1;

    $array = array();
    if ($teamID!=="") {
        $now = time();

        $query = "select * from games,season where games.seasonID = season.id and games.datetime > ".$now." and season.teamID=".$teamID." order by games.datetime";
        $result = mysql_query($query, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }
        $num = mysql_numrows($result);
        if ($num>0){
            $item -> id = mysql_result($result, 0, "games.id");
            $item -> gameID = mysql_result($result, 0, "games.id");
            $item -> seasonID = mysql_result($result, 0, "games.seasonID");
            $item -> homegame = mysql_result($result, 0, "games.homegame");
//            $item -> membersPresentUnknown = mysql_result($result, 0, "games.membersPresentUnknown");
            $item -> membersPresentYes = mysql_result($result, 0, "games.membersPresentYes");
            $item -> membersPresentNo = mysql_result($result, 0, "games.membersPresentNo");
            $item -> score = mysql_result($result, 0, "games.score");
            $item -> points = mysql_result($result, 0, "games.points");
            $item -> gameType = mysql_result($result, 0, "games.gameType");
            $item -> gameStatus = mysql_result($result, 0, "games.gameStatus");
            if ($item -> points==null) $item -> points = 0;
            if ($item -> score==null) $item -> score = "";
        }
    }
    return $item;
}



/**************************************************
 */
function loadGame($gameID) {
	global $conn;
	$item = new \stdClass();
	$query = "SELECT * FROM games,team where games.teamID=team.id and games.id='" . $gameID . "'";
	$result = mysql_query($query, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$num = mysql_numrows($result);
	if ($num > 0) {
        $item -> id = mysql_result($result, 0, "games.id");
        $item -> seasonID = mysql_result($result, 0, "games.seasonID");
        $item -> opponent = mysql_result($result, 0, "games.opponent");
        $item -> messages = mysql_result($result, 0, "games.messages");
		$item -> gamedate = mysql_result($result, 0, "datetime");
//        $item -> membersPresentUnknown = mysql_result($result, 0, "games.membersPresentUnknown");
        $item -> membersPresentYes = mysql_result($result, 0, "games.membersPresentYes");
        $item -> membersPresentNo = mysql_result($result, 0, "games.membersPresentNo");
        $item -> goals = mysql_result($result, 0, "games.goals");
        $item -> homegame = mysql_result($result, 0, "games.homegame");
        $item -> meetingpoint = mysql_result($result, 0, "games.meetingpoint");
        $item -> score = mysql_result($result, 0, "games.score");
        $item -> membersPresentYes = mysql_result($result, 0, "games.membersPresentYes");
        $item -> points = mysql_result($result, 0, "games.points");
        $item -> gameType = mysql_result($result, 0, "games.gameType");
        $item -> gameStatus = mysql_result($result, 0, "games.gameStatus");
        if ($item -> points==null) $item -> points = 0;
        if ($item -> score==null) $item -> score = "";
        
        $item -> list1 = mysql_result($result, 0, "games.list1");
        $item -> list2 = mysql_result($result, 0, "games.list2");
        $item -> list3 = mysql_result($result, 0, "games.list3");
        $item -> list4 = mysql_result($result, 0, "games.list4");
        $item -> list5 = mysql_result($result, 0, "games.list5");
        $item -> list6 = mysql_result($result, 0, "games.list6");
        $item -> list7 = mysql_result($result, 0, "games.list7");
        $item -> list8 = mysql_result($result, 0, "games.list8");
        $item -> list9 = mysql_result($result, 0, "games.list9");
        $item -> list10 = mysql_result($result, 0, "games.list10");
                
        $item -> listname1 = mysql_result($result, 0, "team.listname1");
        $item -> listname2 = mysql_result($result, 0, "team.listname2");
        $item -> listname3 = mysql_result($result, 0, "team.listname3");
        $item -> listname4 = mysql_result($result, 0, "team.listname4");
        $item -> listname5 = mysql_result($result, 0, "team.listname5");
        $item -> listname6 = mysql_result($result, 0, "team.listname6");
        $item -> listname7 = mysql_result($result, 0, "team.listname7");
        $item -> listname8 = mysql_result($result, 0, "team.listname8");
        $item -> listname9 = mysql_result($result, 0, "team.listname9");
        $item -> listname10 = mysql_result($result, 0, "team.listname10");
                
        $item -> listtype1 = mysql_result($result, 0, "team.listtype1");
        $item -> listtype2 = mysql_result($result, 0, "team.listtype2");
        $item -> listtype3 = mysql_result($result, 0, "team.listtype3");
        $item -> listtype4 = mysql_result($result, 0, "team.listtype4");
        $item -> listtype5 = mysql_result($result, 0, "team.listtype5");
        $item -> listtype6 = mysql_result($result, 0, "team.listtype6");
        $item -> listtype7 = mysql_result($result, 0, "team.listtype7");
        $item -> listtype8 = mysql_result($result, 0, "team.listtype8");
        $item -> listtype9 = mysql_result($result, 0, "team.listtype9");
        $item -> listtype10 = mysql_result($result, 0, "team.listtype10");
                
        if ($item -> homegame==null) $item -> homegame = false;
	}
	return $item;
}


/**************************************************
 */
function saveGame($gameID, $score, $points,$meetingpoint, $homegame, $datetime, $membersPresentYes, $membersPresentNo, $opponent,
        $goals,$gameType, $gameStatus, $list1,$list2,$list3,$list4,$list5,$list6,$list7,$list8,$list9,$list10) {
	global $conn;
    $homegameInt = 0;
    if ($homegame==true) {
        $homegameInt=1;
    } 
    
    
    $score = mysql_real_escape_string($score);
    $meetingpoint = mysql_real_escape_string($meetingpoint);
    $membersPresentYes = mysql_real_escape_string($membersPresentYes);
    $membersPresentNo = mysql_real_escape_string($membersPresentNo);
//    $membersPresentUnknown = mysql_real_escape_string($membersPresentUnknown);
    $opponent = mysql_real_escape_string($opponent);
    $goals = mysql_real_escape_string($goals);
    $list1 = mysql_real_escape_string($list1);
    $list2 = mysql_real_escape_string($list2);
    $list3 = mysql_real_escape_string($list3);
    $list4 = mysql_real_escape_string($list4);
    $list5 = mysql_real_escape_string($list5);
    $list6 = mysql_real_escape_string($list6);
    $list7 = mysql_real_escape_string($list7);
    $list8 = mysql_real_escape_string($list8);
    $list9 = mysql_real_escape_string($list9);
    $list10 = mysql_real_escape_string($list10);
    $gameType = mysql_real_escape_string($gameType);
    $gameStatus = mysql_real_escape_string($gameStatus);
        
        
	$q = "UPDATE games SET score='$score' , points='.$points.', meetingpoint='".$meetingpoint."', ".   
	"homegame='$homegameInt', datetime='$datetime'".
	", membersPresentYes='$membersPresentYes', membersPresentNo='$membersPresentNo' ".
    ", opponent='$opponent'".
    ", goals='$goals'".
    ", gameType='$gameType'".
    ", gameStatus='$gameStatus'".
    ", list1='".$list1."'".
    ", list2='".$list2."'".
    ", list3='".$list3."'".
    ", list4='".$list4."'".
    ", list5='".$list5."'".
    ", list6='".$list6."'".
    ", list7='".$list7."'".
    ", list8='".$list8."'".
    ", list9='".$list9."'".
    ", list10='".$list10."'".
    "  WHERE id = '$gameID';";
    logSQL($q,"saveGame", 0);
    
	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}

}

/**************************************************
 */
function addMessage($gameID, $newMessage) {
    global $conn;
    $message = "";
    $query = "SELECT messages FROM games where id=" . $gameID;
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    if ($num>0) {
        $message = mysql_result($result, 0, "messages");
    }
    
    $message = $newMessage.$message;
    
    $q = "UPDATE games SET messages='".mysql_real_escape_string($message)."' WHERE id = ".$gameID.";";
    logSQL($q,"addMessage", 0);
        $res = mysql_query($q, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    
}



function getGameDetails($messages,$membersYesStr, $membersNoStr, $membersUnknownStr,$game,$meetingpoint,$dateStr,$timeStr,$dayOfWeek, $link){
    $resultText='
<table>
<tr>
<td colspan=99>
<b><u>Wedstrijd gegevens</u></b>
</td>
</tr>
<tr>
<td>wedstrijd</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$game.'</td>
</tr>
<tr>
<td>datum</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$dayOfWeek." ".$dateStr.'</td>
</tr>
<tr>
<td>tijd</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$timeStr.'</td>
</tr>

<tr>
<td>verzamelplek</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$meetingpoint.'</td>
</tr>
<tr>
<td>link naar wedstrijd</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td><a href='.$link.'>'.$link.'</a></td>
</tr>

<tr>
<td colspan=99>
<b><u>Aanwezigheid</u></b>
</td>
</tr>

<tr>
<td>Aanwezig</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$membersYesStr.'</td>
</tr>

<tr>
<td>Afwezig</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$membersNoStr.'</td>
</tr>

<tr>
<td>Nog niet aangegeven</td>
<td>&nbsp;&nbsp;:&nbsp;&nbsp;</td>
<td>'.$membersUnknownStr.'</td>
</tr>

<tr>
<td colspan=99>
<b><u>Berichten</u></b>
</td>
</tr>

<tr>
<td colspan=99>'.$messages.'</td>
</tr>


</table>
';
    
    return $resultText;
    
}

/**************************************************
 */
function emailMessages($gameID) {
    global $conn;
    $item = new \stdClass();
    $query = "SELECT *,date_format(games.datetime, '%d %M %Y') as gameDateStr, date_format(games.datetime, '%k:%i') as gameTimeStr FROM games,team where games.teamID=team.id and games.id='" . $gameID . "'";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    
    $opponent = "";
    $messages = "";
    $gamedate = "";
    $homegame = "";
    $meetingpoint = "";
    $teamname = "";
    $teamID = 0;
    
    $daysfWeek = array(
    0 => "zondag",
    1 => "maandag",
    2 => "dinsdag",
    3 => "woensdag",
    4 => "donderdag",
    5 => "vrijdag",
    6 => "zaterdag");
    
   
    if ($num > 0) {
        $opponent = mysql_result($result, 0, "games.opponent");
        $messages = mysql_result($result, 0, "games.messages");
        $datetime = mysql_result($result, 0, "games.datetime");
        $gamedate =   date('d-m-Y', $datetime-date("Z",$datetime)); 
        $gametime =   date('H:i', $datetime-date("Z",$datetime)); 
        $dayOfWeek =   $daysfWeek[date('w', $datetime-date("Z",$datetime))]; 
        $homegame = mysql_result($result, 0, "games.homegame");
        $meetingpoint = mysql_result($result, 0, "games.meetingpoint");
        $teamname = mysql_result($result, 0, "team.teamname");
        $teamID = mysql_result($result, 0, "team.id");
        $membersPresentYes = mysql_result($result, 0, "games.membersPresentYes");
        $membersPresentNo = mysql_result($result, 0, "games.membersPresentNo");
        if ($homegame==null) $homegame = false;
    }
    
    $game = $teamname."-".$opponent;
    if (!$homegame){
        $game = $opponent."-".$teamname;
    }
    
    $link = "http://www.mijnsportwedstrijden.nl/index.php?team=".$teamID."&section=wedstrijd&game=".$gameID;
    
    
    // split all present members-ids in an array
    $presentIDs = explode(" ", $membersPresentYes);    
    $notpresentIDs = explode(" ", $membersPresentNo);

    // find all members and players
    $allMembers = array();  
    $allPlayers = array();  
    $query = "SELECT * FROM teammember where teammember.teamID='" . $teamID . "'";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $deleted = 1==mysql_result($result, $i, "teammember.deleted");
        $supporter = 1==mysql_result($result, $i, "teammember.supporter");
        $nickname = mysql_result($result, $i, "teammember.nickname");
        $id = mysql_result($result, $i, "teammember.id");
        $i++;
        $allMembers[$id]=$nickname;
        if ($deleted) continue;
        if ($supporter) continue;
        $allPlayers[$id]=$id;
    }
    // replace IDs for names for YES
    $presentOrNotPresentIDsArray = array();  
    
    $presentText = "";
    $count = 0;
    foreach ($presentIDs as $id) {
        if ($id=="") continue;
        if ($count>0) $presentText .= ", ";
        $count++;
        $presentText .= $allMembers[$id];
        $presentOrNotPresentIDsArray[$id]="yes";
    }
    $presentText = $count." spelers (".$presentText.")";

    // replace IDs for names for NO
    $notpresentText = "";
    $count = 0;
    foreach ($notpresentIDs as $id) {
        if ($id=="") continue;
        if ($count>0) $notpresentText .= ", ";
        $count++;
        $notpresentText .= $allMembers[$id];
        $presentOrNotPresentIDsArray[$id]="yes";
    }
    $notpresentText = $count." spelers (".$notpresentText.")";
    
    // find IDs for names for Unknown
    $unknownText = "";
    $count = 0;
        foreach ($allPlayers as $id) {
        if (!isset($presentOrNotPresentIDsArray[$id])){
            if ($count>0) $unknownText .= ", ";
            $count++;
            $unknownText .= $allMembers[$id];
        }
    }
    $unknownText = $count." spelers (".$unknownText.")";
    
        
    
    $message = "";
    $message .= "<body BGCOLOR='#fff'>";
    $message .= " <STYLE type='text/css'>";
    $message .= "   body {font-family: Arial;color: #000;text-decoration : none; }";       
    $message .= " </STYLE>";    
    $message .= getGameDetails($messages,$presentText, $notpresentText, $unknownText,$game,$meetingpoint,$gamedate,$gametime,$dayOfWeek, $link);
    
/*
    $message .= "<table>";
    $message .= "<tr><td valign=top colspan=99><b><u>Wedstrijd gegevens</u></b></td></tr>";
    $message .= "<tr><td valign=top>wedstrijd</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$game."</td></tr>";
    $message .= "<tr><td valign=top>Datum</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$gamedate."</td></tr>";
    $message .= "<tr><td valign=top>Tijd</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$gametime."</td></tr>";
    $message .= "<tr><td valign=top>Verzamelplek</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$meetingpoint."</td></tr>";
    $message .= "<tr><td valign=top>Link naar wedstrijd</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$link."</td></tr>";
    $message .= "<tr><td valign=top colspan=99 height=10></td></tr>";
    
    $message .= "<tr><td valign=top colspan=99><b><u>Aanwezigheid</u></b></td></tr>";
    $message .= "<tr><td valign=top>Aanwezig</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$presentText."</td></tr>";
    $message .= "<tr><td valign=top>Afwezig</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$notpresentText."</td></tr>";
    $message .= "<tr><td valign=top>Nog niet aangegeven</td><td valign=top>&nbsp;&nbsp;:&nbsp;&nbsp;</td><td valign=top>".$unknownText."</td></tr>";
    $message .= "<tr><td valign=top colspan=99 height=10></td></tr>";
    
    $message .= "<tr><td valign=top colspan=99><b><u>Berichten</u></b></td></tr>";
    $message .= "<tr><td valign=top colspan=99>".$messages."</td></tr>";
    $message .= "</table>";
*/    
    $message .= "</body>";
    
    
    
    $message;
    

    $query = "SELECT * FROM teammember,users where teammember.teamID='" . $teamID . "' and teammember.userID=users.id and (deleted is NULL or deleted=0)";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $admin = mysql_result($result, $i, "teammember.admin");
        $deleted = 1==mysql_result($result, $i, "teammember.deleted");
        $supporter = 1==mysql_result($result, $i, "teammember.supporter");
        $acceptEmail = mysql_result($result, $i, "teammember.acceptEmail");
        $email = mysql_result($result, $i, "users.email");
        $phonenumber = mysql_result($result, $i, "users.phonenumber");
        if ($email==null) $email = ""; 
        if ($phonenumber==null) $phonenumber = "";
        $i++;
        
        if ($deleted) continue;
        if ($supporter) continue;
        if (!$acceptEmail) continue;
        if ($email=="") continue;
                        
        //echo  $email.":".$admin;
        sendEmail($email,"mijnsportwedstrijden.nl update: nieuw bericht voor ".$game." op ".$gamedate." ".$gametime,$message);
    }
    
}




/**************************************************
 */
function loadSeasons($teamID) {
	global $conn;

	$array = array();
	$query = "SELECT season, id FROM season where teamID='" . $teamID . "' order by season";
	$result = mysql_query($query, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$num = mysql_numrows($result);
	$i = 0;
	while ($i < $num) {
		$season = mysql_result($result, $i, "season");
		$seasonid = mysql_result($result, $i, "id");
		$item = new \stdClass();
		$item -> id = $seasonid;
		$item -> season = $season;
		$array[] = $item;
		$i++;
	}
	return $array;
}

/**************************************************
 */
function addSeasons($teamID, $season) {
	global $conn;
	$q = "INSERT INTO season (`teamID` , `season`) VALUES ($teamID,'".mysql_real_escape_string($season)."')";
    logSQL($q,"add season", 0);
	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$id = mysql_insert_id();
	return $id;
}

/**************************************************
 */
function updateSeasons($seasons) {
	global $conn;
	foreach ($seasons as $season) {
		if ($season != null) {
			$q = "UPDATE season SET season='" . $season -> season . "' WHERE id = '" . $season -> id . "';";
            logSQL($q,"updateSeasons", 0);
			$res = mysql_query($q, $conn);
			if (mysql_errno()) {
				throw new \Exception(mysql_error());
			}
		}
	}

}

/**************************************************
 */
function removeSeason($seasonID) {
	global $conn;
	$q = "DELETE from season WHERE id = '" . $seasonID . "';";
    logSQL($q,"removeSeason", 0);
	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}

}

/**************************************************
 */
function addGame($teamID, $seasonID, $gameDate, $gameOpponent, $homegame) {
	global $conn;

    $homegameInt = 0;
    if ($homegame==true) {
        $homegameInt=1;
    } 
    $gameOpponent = mysql_real_escape_string($gameOpponent);	
	$q = "INSERT INTO games (`datetime`,`opponent`,`seasonID`,`teamID`,`homegame`) VALUES ('$gameDate','$gameOpponent','$seasonID','$teamID',$homegameInt)";
    logSQL($q,"add game", 0);
	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$teamID = mysql_insert_id();

	return $teamID;
}

/**************************************************
 */
function addGames($games) {
    global $conn;


    foreach ($games as $game) {
        if ($game != null) {
            
            $homegameInt = 0;
            if ($game->homegame==true) {
                $homegameInt=1;
            } 
            
            $game->gameOpponent = mysql_real_escape_string($game->gameOpponent);    
            
            $q = "INSERT INTO games (`datetime`,`opponent`,`seasonID`,`teamID`,`homegame`) VALUES ('$game->gameDate','$game->gameOpponent','$game->seasonID','$game->teamID','$homegameInt')";
            logSQL($q,"add game", 0);
            $res = mysql_query($q, $conn);
            if (mysql_errno()) {
                throw new \Exception(mysql_error());
            }
        }
    }
       
    return "";
}


function saveTeammembers($changedLists){
    global $conn;
    foreach ($changedLists as $changedMember) {
        $supportedValue = 0;
        $adminValue = 0;
        $invallerValue = 0;
        if ($changedMember->admin){
            $adminValue = 1;
        }
        if ($changedMember->supporter){
            $supportedValue = 1;
        }
        if ($changedMember->invaller){
            $invallerValue = 1;
        }
        $query = "UPDATE teammember SET admin=".$adminValue.",supporter=".$supportedValue.",invaller=".$invallerValue." where id=".$changedMember->id.";";
        logSQL($query,"saveTeammembers", 0);
        $result = mysql_query($query, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }
    }
}

function saveTeammembers2($changedLists){
    global $conn;
    foreach ($changedLists as $changedMember) {
        $acceptEmail = 0;
        if ($changedMember->acceptEmail){
            $acceptEmail = 1;
        }
        $nickname = mysql_real_escape_string($changedMember->nickname);
        $query = "UPDATE teammember SET acceptEmail=".$acceptEmail.",nickname='".$nickname."' where id=".$changedMember->id.";";
        logSQL($query,"saveTeammembers2", 0);
        $result = mysql_query($query, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }
    }
}

/**************************************************
 */
function loadTeammembers($teamID) {
	global $conn;
	$array = array();
	$query = "SELECT * FROM teammember,users where teammember.teamID='" . $teamID . "' and teammember.userID=users.id";
	$result = mysql_query($query, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
	$num = mysql_numrows($result);
	$i = 0;
	while ($i < $num) {
		$item = new \stdClass();
        $item -> id = mysql_result($result, $i, "teammember.id");
		$item -> userID = mysql_result($result, $i, "teammember.userID");
		$item -> nickname = mysql_result($result, $i, "teammember.nickname");
        $item -> admin = mysql_result($result, $i, "teammember.admin");
        $item -> deleted = 1==mysql_result($result, $i, "teammember.deleted");
        $item -> supporter = 1==mysql_result($result, $i, "teammember.supporter");
        $item -> invaller = 1==mysql_result($result, $i, "teammember.invaller");
        $item -> invitationID = mysql_result($result, $i, "teammember.invitationID");
        $item -> invitationEmail = mysql_result($result, $i, "teammember.invitationEmail");
        $item -> invitationDate = mysql_result($result, $i, "teammember.invitationDate");
        $item -> acceptEmail = mysql_result($result, $i, "teammember.acceptEmail");
        $item -> email = mysql_result($result, $i, "users.email");
        $item -> phonenumber = mysql_result($result, $i, "users.phonenumber");
        if ($item -> email==null) $item -> email = ""; 
        if ($item -> phonenumber==null) $item -> phonenumber = ""; 
        $array[] = $item;
		$i++;
	}

    //also return all users that are invited and have no user yet
    $query = "SELECT * FROM teammember where teammember.teamID='" . $teamID . "' and (teammember.userID is NULL || teammember.userID = 0)";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "teammember.id");
        $item -> userID = mysql_result($result, $i, "teammember.userID");
        $item -> nickname = mysql_result($result, $i, "teammember.nickname");
        $item -> admin = mysql_result($result, $i, "teammember.admin");
        $item -> deleted = 1==mysql_result($result, $i, "teammember.deleted");
        $item -> supporter = 1==mysql_result($result, $i, "teammember.supporter");
        $item -> invaller = 1==mysql_result($result, $i, "teammember.invaller");
        $item -> invitationID = mysql_result($result, $i, "teammember.invitationID");
        $item -> invitationEmail = mysql_result($result, $i, "teammember.invitationEmail");
        $item -> invitationDate = mysql_result($result, $i, "teammember.invitationDate");
        $item -> acceptEmail = mysql_result($result, $i, "teammember.acceptEmail");
        $item -> email = "";
        $item -> phonenumber = "";
        $array[] = $item;
        $i++;
    }

    


	return $array;
}


/**************************************************
 */
function loadTeammembersOfUser($userID) {
    global $conn;
    $array = array();
    $query = "SELECT teammember.*,team.teamname FROM teammember,team where userID='" . $userID . "' and team.id=teammember.teamID  and (teammember.deleted=0 || teammember.deleted is NULL)";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "teammember.id");
        $item -> userID = mysql_result($result, $i, "teammember.userID");
        $item -> nickname = mysql_result($result, $i, "teammember.nickname");
        $item -> admin = mysql_result($result, $i, "teammember.admin");
        $item -> deleted = 1==mysql_result($result, $i, "teammember.deleted");
        $item -> supporter = 1==mysql_result($result, $i, "teammember.supporter");
        $item -> invaller = 1==mysql_result($result, $i, "teammember.invaller");
        $item -> invitationID = mysql_result($result, $i, "teammember.invitationID");
        $item -> invitationEmail = mysql_result($result, $i, "teammember.invitationEmail");
        $item -> invitationDate = mysql_result($result, $i, "teammember.invitationDate");
        $item -> acceptEmail = mysql_result($result, $i, "teammember.acceptEmail");
        $item -> teamname = mysql_result($result, $i, "team.teamname");
                $array[] = $item;
        $i++;
    }
    return $array;
}
/**************************************************
 */
function removeTeammember($teammemberID) {
	global $conn;
	$q = "UPDATE teammember set deleted=1 WHERE id = '" . $teammemberID . "';";
    logSQL($q,"removeTeammember", 0);
	$res = mysql_query($q, $conn);
	if (mysql_errno()) {
		throw new \Exception(mysql_error());
	}
}


/**************************************************
 */
function loadListData($seasonID) {
    global $conn;
    $array = array();
    $query = "SELECT * FROM games where seasonID='" . $seasonID . "' order by games.datetime";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {

        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "id");
        $gamedate = mysql_result($result, $i, "datetime");
        $item -> gamedate = $gamedate;
        $item -> opponent = mysql_result($result, $i, "opponent");
        $item -> homegame = mysql_result($result, $i, "homegame");

//        $item -> membersPresentUnknown = mysql_result($result, $i, "games.membersPresentUnknown");
        $item -> membersPresentYes = mysql_result($result, $i, "games.membersPresentYes");
        $item -> membersPresentNo = mysql_result($result, $i, "games.membersPresentNo");
        $item -> goals = mysql_result($result, $i, "games.goals");

        $item -> list1 = mysql_result($result, $i, "list1");
        $item -> list2 = mysql_result($result, $i, "list2");
        $item -> list3 = mysql_result($result, $i, "list3");
        $item -> list4 = mysql_result($result, $i, "list4");
        $item -> list5 = mysql_result($result, $i, "list5");
        $item -> list6 = mysql_result($result, $i, "list6");
        $item -> list7 = mysql_result($result, $i, "list7");
        $item -> list8 = mysql_result($result, $i, "list8");
        $item -> list9 = mysql_result($result, $i, "list9");
        $item -> list10 = mysql_result($result, $i, "list10");
        $array[] = $item;
        $i++;
    }
    return $array;
}

function saveListData($changedLists) {
    global $conn;
    
    
    foreach ($changedLists as $changedList) {
//        echo "update ".$changedList->listName." to ".$changedList->listData." for game ".$changedList->gameID."\n";
        $query = "UPDATE games SET ".$changedList->listName."='".mysql_real_escape_string($changedList->listData)."' where id=".$changedList->gameID.";";
        logSQL($query,"saveListData", 0);
        $result = mysql_query($query, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }
                
    }
}


function addList($listType,$listName,$teamID){
    global $conn;
    $query = "SELECT * FROM team where id='" . $teamID . "'";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $listToUse = null;
    $listTypeFieldName = null;
    if ($num > 0) {
        for ($i=10; $i>0; $i--){
            $listname = mysql_result($result, 0, "team.listname".$i);
            if ($listname=="" || $listname==null) {
                $listToUse = "listname".$i;
                $listTypeFieldName = "listtype".$i;
            }
        }
    }
    if ($listToUse == null){
        throw new \Exception("Geen vrije lijst meer over (max 10 lijsten)");
    }

    // set the listname for the new list
    $query = "UPDATE team SET ".$listToUse."='" . $listName . "',".$listTypeFieldName."=".$listType." where id=".$teamID.";";
    logSQL($query,"addList", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}

function removeList($listID,$teamID){
    global $conn;
    $query = "UPDATE team SET listname".$listID."='' where id=".$teamID.";";
    logSQL($query,"removeList-team", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    
        
    $query = "UPDATE games SET list".$listID."='' where teamID=".$teamID.";";
    logSQL($query,"removeList-games", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}

function updateLists($teamID,$listName1,$listName2,$listName3
    ,$listName4,$listName5,$listName6,$listName7
    ,$listName8,$listName9,$listName10){
    global $conn;
    $query = "UPDATE team SET listname1='".mysql_real_escape_string($listName1)."',".
    "listname2='".mysql_real_escape_string($listName2)."',".
    "listname3='".mysql_real_escape_string($listName3)."',".
    "listname4='".mysql_real_escape_string($listName4)."',".
    "listname5='".mysql_real_escape_string($listName5)."',".
    "listname6='".mysql_real_escape_string($listName6)."',".
    "listname7='".mysql_real_escape_string($listName7)."',".
    "listname8='".mysql_real_escape_string($listName8)."',".
    "listname9='".mysql_real_escape_string($listName9)."',".
    "listname10='".mysql_real_escape_string($listName10)."' ".
        " where id=".$teamID.";";
    logSQL($query,"updateListsm", 0);

    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
        
}


function removeMemberFromList($list,$memberID){
    $list = " ".$list." ";
    $list = str_replace(" ".$memberID." ", " ", $list);
    return $list; 
}

function setAanwezig($gameID,$memberID){
    changeAanwezigheid($gameID,$memberID,true,false,false);
}

function setAfwezig($gameID,$memberID){
    changeAanwezigheid($gameID,$memberID,false,true,false);
}

function setOnbekend($gameID,$memberID){
    changeAanwezigheid($gameID,$memberID,false,false,true);
}


function changeAanwezigheid($gameID,$memberID,$aanwezig,$afwezig,$onbekend){
    global $conn;

    $query = "SELECT membersPresentYes,membersPresentNo FROM games where id='" . $gameID . "'";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $listToUse = null;
    $listTypeFieldName = null;
    $membersPresentYes = "";
    $membersPresentNo = "";
    //$membersPresentUnknown = "";
    if ($num > 0) {
        $membersPresentYes = mysql_result($result, 0, "membersPresentYes");
        $membersPresentNo = mysql_result($result, 0, "membersPresentNo");
        //$membersPresentUnknown = mysql_result($result, 0, "membersPresentUnknown");
    }
    // remove the list from all 3 lists
    $membersPresentYes = removeMemberFromList($membersPresentYes,$memberID);
    $membersPresentNo = removeMemberFromList($membersPresentNo,$memberID);
    //$membersPresentUnknown = removeMemberFromList($membersPresentUnknown,$memberID);
    
    if ($aanwezig){
        $membersPresentYes = $membersPresentYes." ".$memberID;
    }
    if ($afwezig){
        $membersPresentNo = $membersPresentNo." ".$memberID;
    }
    //if ($onbekend){
    //    $membersPresentUnknown = $membersPresentUnknown." ".$memberID;
    //}
        
    $query = "UPDATE games SET membersPresentYes='" . $membersPresentYes . "', membersPresentNo='".$membersPresentNo."' where id=".$gameID.";";
    logSQL($query,"changeAanwezigheid", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}

function changeNickname($nickname,$memberID){
    global $conn;
        
    $query = "UPDATE teammember SET nickname='".mysql_real_escape_string($nickname)."' where id=".$memberID.";";
    logSQL($query,"changeNickname", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
}

function changePW($userID,$oldPW, $newPW1, $newPW2){
    global $conn;
    
    $oldmd5pass = md5($oldPW);
    $newmd5pass = md5($newPW2);
    
    /* Verify that user is in database */
    $q = "select password from users where id = ".$userID;
    $result = mysql_query($q, $conn);
    $num = mysql_numrows($result);

    if (!$result || $num < 1) {
        throw new \Exception("gebruiker niet gevonden");
    }
    $currpassword = mysql_result($result, 0, "password");
    
    if ($currpassword!=$oldmd5pass){
        throw new \Exception("oud wachtwoord is niet correct");
    }
    
    if ($newPW1!=$newPW2){
        throw new \Exception("de wachtwoorden komen niet overeen");
    }
    
    $query = "UPDATE users SET password='".mysql_real_escape_string($newmd5pass)."' where id=".$userID.";";
    logSQL($query,"changePW", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    
}
/**************************************************
 */
function dbSummary() {
    global $conn;
    $item = new \stdClass();
    $query = "select". 
"(select count(*) from games ) as gamecount,".
"(select count(*) from season ) as seasoncount,".
"(select count(*) from team ) as teamcount,".
"(select count(*) from teammember ) as teammembercount,".
"(select count(*) from users ) as userscount";
    
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item -> gamecount = mysql_result($result, $i, "gamecount");
        $item -> seasoncount = mysql_result($result, $i, "seasoncount");
        $item -> teamcount = mysql_result($result, $i, "teamcount");
        $item -> teammembercount = mysql_result($result, $i, "teammembercount");
        $item -> userscount = mysql_result($result, $i, "userscount");
        $i++;
    }

    return $item;
}


/**************************************************
 */
function adminListAllTeams() {
    global $conn;
    $array = array();
    $query = "select team.id , team.teamname ,". 
    "(select count(*) from games where games.teamID = team.id) as gamecount,".
    "(select count(*) from season where season.teamID = team.id) as seasoncount,".
    "(select count(*) from teammember where teammember.teamID = team.id) as teammembercount from team";
    
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> teamname = mysql_result($result, $i, "teamname");
        $item -> teamid = mysql_result($result, $i, "id");
        $item -> gamecount = mysql_result($result, $i, "gamecount");
        $item -> seasoncount = mysql_result($result, $i, "seasoncount");
        $item -> teammembercount = mysql_result($result, $i, "teammembercount");
        $array[] = $item;
        $i++;
    }

    return $array;
}

function adminRemoveTeam($teamID){
    global $conn;
    if ($teamID=="") return;
    $query = "delete from season where teamID=".$teamID;
    logSQL($query,"adminRemoveTeam-remove season", 0);
        $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }

    $query = "delete from games where teamID=".$teamID;
    logSQL($query,"adminRemoveTeam-remove games", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }

    $query = "delete from teammember where teamID=".$teamID;
    logSQL($query,"adminRemoveTeam-remove teammember", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }

    $query = "delete from team where id=".$teamID;
    logSQL($query,"adminRemoveTeam-remove team", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
        
}



/**************************************************
 */
function adminListAllUsers() {
    global $conn;
    $array = array();
    $query = "select users.id , users.username,". 
    "(select count(*) from teammember where teammember.userID = users.id) as teammembercount from users";
    
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> username = mysql_result($result, $i, "username");
        $item -> id = mysql_result($result, $i, "id");
        $item -> teammembercount = mysql_result($result, $i, "teammembercount");
        $array[] = $item;
        $i++;
    }

    return $array;
}

function adminRemoveUser($userID){
    global $conn;
    if ($userID=="") return;
    $query = "delete from teammember where userID=".$userID;
    logSQL($query,"adminRemoveUser-remove teammembers", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }

    $query = "delete from users where id=".$userID;
    logSQL($query,"adminRemoveUser-remove user", 0);
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }       
}


/**************************************************
 */
function adminListAllChanges() {
    global $conn;
    $array = array();
    $query = "select * from log order by id desc limit 50";
    
    
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> user = mysql_result($result, $i, "username");
        $item -> date = mysql_result($result, $i, "date");
        $item -> time = mysql_result($result, $i, "time");
        $item -> action = mysql_result($result, $i, "description");
        $array[] = $item;
        $i++;
    }

    return $array;
}


function checkUser($username,$pw){
    global $conn;
    $md5pass = md5($pw);
    $q = "select id,password from users where username = '".$username."'";
    $result = mysql_query($q, $conn);
    if (!$result) {
        return -1;
    }

    $num = mysql_numrows($result);
    if ($num < 1) {
        return -1;
    }
   
    $currpassword = mysql_result($result, 0, "password");
    $currid = mysql_result($result, 0, "id");    
    if ($currpassword!=$md5pass){
        return -1;
    }
    return $currid;
}


/**************************************************
 */
function getGames($userID,$query) {
    global $conn;

    $array = array();
    
    // find all teams of this user
    $teamquery = "select team.* from teammember, users, team where users.id=teammember.userID and teammember.teamID=team.id and users.ID=".$userID;
    $result = mysql_query($teamquery, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $teamsArray = array();
    $i=0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "id");
        $item -> teamname = mysql_result($result, $i, "teamname");
        $item -> listname1 = mysql_result($result, 0, "listname1");
        $item -> listname2 = mysql_result($result, 0, "listname2");
        $item -> listname3 = mysql_result($result, 0, "listname3");
        $item -> listname4 = mysql_result($result, 0, "listname4");
        $item -> listname5 = mysql_result($result, 0, "listname5");
        $item -> listname6 = mysql_result($result, 0, "listname6");
        $item -> listname7 = mysql_result($result, 0, "listname7");
        $item -> listname8 = mysql_result($result, 0, "listname8");
        $item -> listname9 = mysql_result($result, 0, "listname9");
        $item -> listname10 = mysql_result($result, 0, "listname10");
        $item -> listtype1 = mysql_result($result, 0, "listtype1");
        $item -> listtype2 = mysql_result($result, 0, "listtype2");
        $item -> listtype3 = mysql_result($result, 0, "listtype3");
        $item -> listtype4 = mysql_result($result, 0, "listtype4");
        $item -> listtype5 = mysql_result($result, 0, "listtype5");
        $item -> listtype6 = mysql_result($result, 0, "listtype6");
        $item -> listtype7 = mysql_result($result, 0, "listtype7");
        $item -> listtype8 = mysql_result($result, 0, "listtype8");
        $item -> listtype9 = mysql_result($result, 0, "listtype9");
        $item -> listtype10 = mysql_result($result, 0, "listtype10");
        $teamsArray[$item -> id ] = $item;
        $i++;
    }    
    
    
    // find all nicknames of all teammembers (of all teams)
    $teamPlayersArray = array();
    foreach ($teamsArray as $team) {
        $memberquery = "select teammember.id,teammember.nickname from teammember where teamID=".$team->id;
        $result = mysql_query($memberquery, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }
        $num = mysql_numrows($result);
        $i=0;
        $team->members = array();
        while ($i < $num) {
            $item = new \stdClass();
            $item -> id = mysql_result($result, $i, "id");
            $item -> nickname = mysql_result($result, $i, "nickname");
            $teamPlayersArray[$item -> id] = $item;
            $team->members[] = $item;; 
            $i++;
        }            
    }
    
//var_dump($teamsArray);    
    
    // find all games   
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    
    $daysfWeek = array(
    0 => "zondag",
    1 => "maandag",
    2 => "dinsdag",
    3 => "woensdag",
    4 => "donderdag",
    5 => "vrijdag",
    6 => "zaterdag");
    
    
    while ($i < $num) {
        $gamedate = mysql_result($result, $i, "datetime");
        
        $item = new \stdClass();
        $item -> gamedate = $gamedate;
        $item -> id = mysql_result($result, $i, "id");
        $item -> teammemberID = mysql_result($result, $i, "teammember.id");
        $item -> opponent = mysql_result($result, $i, "opponent");
        $item -> teamname = mysql_result($result, $i, "team.teamname");
        $item -> teamID = mysql_result($result, $i, "teamID");
        $item -> homegame = mysql_result($result, $i, "homegame");
        $item -> membersPresentYes = mysql_result($result, $i, "membersPresentYes");
        $item -> membersPresentNo = mysql_result($result, $i, "membersPresentNo");
        $item -> score = mysql_result($result, $i, "score");
        $item -> points = mysql_result($result, $i, "points");
        $item -> gameType = mysql_result($result, $i, "gameType");
        $item -> gameStatus = mysql_result($result, $i, "gameStatus");
        $item -> messages = mysql_result($result, $i, "messages");
        $item -> meetingpoint = mysql_result($result, $i, "games.meetingpoint");
                
                
        $item -> gameStr = $item -> opponent." - ".$item -> teamname;
        if ($item -> homegame=="1"){
            $item -> gameStr = $item -> teamname." - ".$item -> opponent;
        }

        $dateStr =   date('d-m-Y', $gamedate-date("Z",$gamedate)); 
        $timeStr =   date('H:i', $gamedate-date("Z",$gamedate)); 
        $dayOfWeek =   $daysfWeek[date('w', $gamedate-date("Z",$gamedate))]; 

        $item -> dateTimeStr = $dayOfWeek." ".$dateStr." ".$timeStr;
        
        // find if the user is present
        $presentIDs = explode(" ", $item -> membersPresentYes);
        $notpresentIDs = explode(" ", $item -> membersPresentNo);
        $remainingMembers = array();
        
        // fill all remainingMembers
        foreach ($teamsArray[$item -> teamID]->members as $member) {
            $remainingMembers[$member->id] = $member->id; 
        }   
        // walk trough YES                
        $zelfAanwezig = "0";
        $allYes = "";
        $firstYes = true;
        foreach ($presentIDs as $id) {
            if ($id==$item -> teammemberID){
                $zelfAanwezig = "1";
            }
            if (isset($teamPlayersArray[$id])){
                $name = $teamPlayersArray[$id]->nickname;
                if (!$firstYes){
                    $allYes.=", ";
                }
                $allYes.=$name;
                $firstYes = false;
                if (isset($remainingMembers[$id])){
                    unset($remainingMembers[$id]);
                }
            }
        }
        
        // walk trough NO                
        $allNo = "";
        $firstNo = true;
        foreach ($notpresentIDs as $id) {
            if ($id==$item -> teammemberID){
                $zelfAanwezig = "2";
            }
            if (isset($teamPlayersArray[$id])){
                $name = $teamPlayersArray[$id]->nickname;
                if (!$firstNo){
                    $allNo.=", ";
                }
                $allNo.=$name;
                $firstNo = false;
                if (isset($remainingMembers[$id])){
                    unset($remainingMembers[$id]);
                }
            }
        }
        
        // walk through unknown
        $allUnknown = "";
        $firstUnknown = true;
        foreach ($remainingMembers as $id) {
            if (isset($teamPlayersArray[$id])){
                $name = $teamPlayersArray[$id]->nickname;
                if (!$firstUnknown){
                    $allUnknown.=", ";
                }
                $allUnknown.=$name;
                $firstUnknown = false;
            }
        }
        
        
        
        $item -> membersPresentYesNames = $allYes;         
        $item -> membersPresentNoNames = $allNo;         
        $item -> membersPresentUnknownNames = $allUnknown;         

        $item -> userPresent = $zelfAanwezig; 
//        $item -> presentCount = count($presentIDs);
        
        $item -> presentCount = 0;
        foreach ($presentIDs as $id) {
            if ($id!=null && $id!=""){
                $item -> presentCount ++;
            }
        }
         
        
                
        if ($item -> points==null) $item -> points = 0;
        if ($item -> score==null) $item -> score = "";
        $array[] = $item;
        $i++;
    }
//var_dump($array);
    return $array;
    
}


/**************************************************
 */
function getUpcomingGames($userID,$filter,$numDays) {
    global $conn;
    $date1 = time();
    $date2 = $date1+60*60*24*$numDays;
    $query = "SELECT distinct games.*,team.teamname, teammember.id  FROM games,teammember,team  where games.teamID = team.id and games.teamID = teammember.teamID and teammember.userID = $userID and datetime>$date1 && datetime<$date2 order by games.datetime";
    return getGames($userID,$query);
    
    
}

/**************************************************
 */
function getPreviousGames($userID,$filter,$numDays) {
    global $conn;
    $date1 = time();
    $date2 = $date1-60*60*24*$numDays;
    $query = "SELECT distinct games.*,team.teamname, teammember.id FROM games,teammember,team  where games.teamID = team.id and games.teamID = teammember.teamID and teammember.userID = $userID and datetime<$date1 && datetime>$date2 order by games.datetime";
    return getGames($userID,$query);
}

/**************************************************
 */
 function updateGame($userID,$type,$gameid,$teamid,$message) {
    global $conn;
    
     // find memberID
    $memberID = 0;
    $q = "select id,nickname from teammember where teamID = $teamid and userID=$userID";
    $res = mysql_query($q, $conn);
    $num = mysql_numrows($res);
    if ($num == 0)
        return -1;
    $memberID = mysql_result($res, 0,"id");
    $nickname = mysql_result($res, 0,"nickname");
        
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
     
     // update aanwezigheid
     if ($type=="setaanwezig"){
        changeAanwezigheid($gameid,$memberID,true,false,false);
     }
     if ($type=="setafwezig"){
        changeAanwezigheid($gameid,$memberID,false,true,false);
     }
     if ($type=="setweetniet"){
        changeAanwezigheid($gameid,$memberID,false,false,true);
     }
     if ($type=="addMessage"){
        // get old message
        $q = "select messages from games where id = $gameid";
        $res = mysql_query($q, $conn);
        if (mysql_errno()) {
            throw new \Exception(mysql_error());
        }        
        $num = mysql_numrows($res);
        if ($num == 0)
            return -1;
        $oldMessage = mysql_result($res, 0,"messages");
         
        date_default_timezone_set('Europe/Amsterdam');
        $gamedate = time();
        $dateStr =   date('d-m', $gamedate); 
        $timeStr =   date('H:i', $gamedate);
        
        $message = str_replace("\n", "<br>", $message);

         
        $newMessage = "<b>op $dateStr om $timeStr schreef $nickname</b><br>".$message."<br><br>";
         
        addMessage($gameid, $newMessage);
        emailMessages($gameid);
     }
          
    $query = "SELECT distinct games.*,team.teamname, teammember.id FROM games,teammember,team  where games.teamID = team.id and games.teamID = teammember.teamID and teammember.userID = $userID and games.id = $gameid";
    return getGames($userID,$query);
}




/**************************************************
 */
function getManagedcompetitions($team,$org) {
    global $conn;
    $array = array();
    $query = "SELECT * FROM managedcompetition,managedcompetitionorganisation,managedcompetitionseason where ".
    "managedcompetition.managedCompetitionSeasonID=managedcompetitionseason.ID AND ".
    "managedcompetitionseason.managedCompetitionOrganisationID=managedcompetitionorganisation.ID";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {

        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "managedcompetition.id");
        $item -> competition = mysql_result($result, $i, "managedcompetition.description");
        $item -> season = mysql_result($result, $i, "managedcompetitionseason.description");
        $item -> organisation = mysql_result($result, $i, "managedcompetitionorganisation.description");
        $array[] = $item;
        $i++;
    }
    return $array;
}




/**************************************************
 */
function loadManagedCompetitionData($managedCompetitionID) {
    global $conn;
    $compData = new \stdClass();
        
    $query = "SELECT * FROM managedcompetition,managedcompetitionorganisation,managedcompetitionseason where ".
    "managedcompetition.managedCompetitionSeasonID=managedcompetitionseason.ID AND ".
    "managedcompetitionseason.managedCompetitionOrganisationID=managedcompetitionorganisation.ID and managedcompetition.id=$managedCompetitionID";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    if ($num!=0) {
        $compData -> id = mysql_result($result, 0, "managedcompetition.id");
        $compData -> competition = mysql_result($result, 0, "managedcompetition.description");
        $compData -> season = mysql_result($result, 0, "managedcompetitionseason.description");
        $compData -> organisation = mysql_result($result, 0, "managedcompetitionorganisation.description");
    }
        
    
    // find all teams of this competition
    $teams = array();
    $teamsIndex = array();
    $query = "SELECT * FROM team";
    // $query = "SELECT * FROM team where managedCompetitieID='" . $managedCompetitionID . "' order by teamname";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "id");
        $item -> teamname = mysql_result($result, $i, "teamname");
        $teams[] = $item;
        $teamsIndex[$item -> id] = $item;
        //echo "##".$item -> id."#".$item -> teamname."<br>";
        $i++;
    }
    
    
    $array = array();
    $query = "SELECT * FROM managedgames,playround where managedgames.playroundID=playround.ID and playround.managedCompetitionID='" . $managedCompetitionID . "' order by managedgames.id";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> id = mysql_result($result, $i, "managedgames.id");
        $item -> teamID1 = mysql_result($result, $i, "managedgames.teamID1");
        $item -> teamID2 = mysql_result($result, $i, "managedgames.teamID2");
        $item -> teamName1 = "";
        $item -> teamName2 = "";
        if (isset($teamsIndex[$item -> teamID1])){
            $item -> teamName1 = $teamsIndex[$item -> teamID1]->teamname;
        }
        if (isset($teamsIndex[$item -> teamID1])){
            $item -> teamName2 = $teamsIndex[$item -> teamID2]->teamname;
        }
        $item -> score = mysql_result($result, $i, "managedgames.score");
        $item -> datetime = mysql_result($result, $i, "managedgames.datetime");
        $item -> playround = mysql_result($result, $i, "playround.description");
        $item -> location = mysql_result($result, $i, "managedgames.location");
        $array[] = $item;
        $i++;
    }
    
    $compData->games = $array; 
    $compData->teams = $teams; 
    return $compData;
}


/**************************************************
 */
function loadMCompetitions($userID) {
    global $conn;
    $array = array();
    $query = "SELECT ".
    "managedcompetition.description as competition ,".
    "managedcompetition.ID as competitionID,".
    "managedcompetitionseason.ID as seasonID,".
    "managedcompetitionorganisation.ID as organisationID,".
    "managedcompetitionseason.description as season,  ".
    "managedcompetitionorganisation.description as organisation ".
    
    "FROM managedcompetition,managedcompetitionseason,managedcompetitionorganisation where ".
    "managedcompetition.managedCompetitionSeasonID=managedcompetitionseason.id and ".
    "managedcompetitionseason.managedCompetitionOrganisationID = managedcompetitionorganisation.id and ".
    "managedcompetitionorganisation.userID = $userID";
    $result = mysql_query($query, $conn);
    if (mysql_errno()) {
        throw new \Exception(mysql_error());
    }
    $num = mysql_numrows($result);
    $i = 0;
    while ($i < $num) {
        $item = new \stdClass();
        $item -> compID = mysql_result($result, $i, "competitionID");;
        $item -> seasonID = mysql_result($result, $i, "seasonID");;
        $item -> organisationID = mysql_result($result, $i, "organisationID");;
                $item -> competition = mysql_result($result, $i, "competition");
        $item -> season = mysql_result($result, $i, "season");
        $item -> organisation = mysql_result($result, $i, "organisation");
        $array[] = $item;
        $i++;
    }
    
    return $array;
}


